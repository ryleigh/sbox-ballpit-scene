@using Sandbox;
@using Sandbox.UI;
@inherits PanelComponent

<root>
	<div class="table">
		<div class="header row">
			<div style="justify-content: flex-start; flex-grow: 1;">
				<div class="name">Name</div>
			</div>
			<div style="justify-content: flex-end; flex-grow: 1;">
				<div class="stat_wins" style="padding-right: 30px;">Wins</div>
				<div class="stat" style="padding-right: 40px;">Losses</div>
				<div class="stat" style="padding-right: 52px;">Time</div>
				<div class="stat" style="padding-right: 0px;">Ping</div>
			</div>
		</div>

		@{
			var rowNum = 0;
		}

		@foreach(var player in Scene.GetAllComponents<PlayerController>().ToList().OrderByDescending(x => x.NumMatchWins))
		{
			var connection = player.Network.OwnerConnection;

			string specialClass = "";
			if(connection == Connection.Local)
				specialClass = "me";

			<div class="row @specialClass @(rowNum % 2 == 0 ? "even_row" : "odd_row")">
				<div class="avatar" style="background-image: url( avatar:@connection.SteamId )"></div>
				<div class="name">
					@connection.DisplayName

					@if(Manager.Instance.GetConnection(0) == connection)
					{
						<div style="padding-left: 4px; font-family: W10Emoji;">@("🟦")</div>
					}
					else 
					{
						@if(Manager.Instance.GetConnection(1) == connection)
						{
							<div style="padding-left: 4px; font-family: W10Emoji;">@("🟩")</div>
						}
					}

					@if(connection.IsHost)
					{
						<div style="opacity:0.1; padding-left: 8px; font-family: Budokan Rounded; padding-top: 3px;">@("(host)")</div>
					}
				</div>
				<div class="stat_container">
					<div class="stat_kills">@($"{player.NumMatchWins}")</div>
					<div style="font-family: W10Emoji;">@("🏆")</div>
				</div>
				<div class="stat_container">
					<div class="stat">@($"{player.NumMatchLosses}")</div>
					<div style="font-family: W10Emoji;">@("💀")</div>
				</div>
				<div class="stat_container">
					<div class="stat">@GetTime(connection)</div>
				</div>
				<div class="stat_container">
					<div class="stat">@(MathF.Round(connection.Ping))</div>
				</div>
			</div>

			rowNum++;
		}
	</div>

</root>

@code
{

	string GetTime(Connection c)
	{
		TimeSpan time = DateTime.UtcNow - c.ConnectionTime;
		return time.TotalSeconds > 3600 ? time.ToString(@"hh\:mm\:ss") : time.ToString(@"mm\:ss");
	}

	protected override void OnUpdate()
	{
		SetClass("hidden", !Input.Down("Score"));
	}

	protected override int BuildHash() 
	{
		var seconds = RealTime.Now;
		var wholeSeconds = seconds.CeilToInt();
		var tenthSeconds = (int)((seconds - (int)seconds) * 10f);

		return System.HashCode.Combine(wholeSeconds, tenthSeconds);
	}
}
